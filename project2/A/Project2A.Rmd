---
title: "Project 2: American Housing Survey"
author: "Zhenqi Yin"
date: "Due 2023-06-23 at 6pm"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = F,message = F)
library(tidyverse)
library(lubridate)
```

## The American Housing Survey

The American Housing Survey is a regular survey conducted by the US Census in coordination with the US Department of Housing and Urban Development that asks questions about housing and affordability. Here is what the US Census says about the AHS:

> The American Housing Survey (AHS) is sponsored by the Department of Housing and Urban Development (HUD) and conducted by the U.S. Census Bureau. The survey has been the most comprehensive national housing survey in the United States since its inception in 1973, providing current information on the size, composition, and quality of the nationâ€™s housing and measuring changes in our housing stock as it ages. The AHS is a longitudinal housing unit survey conducted biennially in odd-numbered years, with samples redrawn in 1985 and 2015 .
>
> The survey provides up-to-date information about the quality and cost of housing in the United States and major metropolitan areas. The survey also includes questions about:
>
> * the physical condition of homes and neighborhoods,
> * the costs of financing and maintaining homes, and
> * the characteristics of people who live in these homes.
> * Planners, policy makers, and community stakeholders use the results of the AHS to assess the housing needs of communities and the country.  These statistics inform decisions that affect the housing opportunities for people of all income levels, ages, and racial and ethnic groups.
>
> Since our country changes rapidly, policymakers in government and private organizations need current housing information to make decisions about programs that will affect people of all income levels, ages, and racial and ethnic groups.

In this project, we will use the 2021 **Public Use Files**. These files strip identifying information from the respondents, including location information such as the state or city. The data are also broken up into four individual files.

* `../data/ahs_2021/household.csv.gz`: The distinct households surveyed.
* `../data/ahs_2021/person.csv.gz`: People living in the households (there may be more than one)
* `../data/ahs_2021/mortgage.csv.gz`: Mortgage (loan) information, which does not apply to all households.
* `../data/ahs_2021/project.csv.gz`: 

You should become familiar with the [codebook for the version of the survey we are using](https://www.census.gov/data-tools/demo/codebook/ahs/ahsdict.html?s_year=2021%20National&s_availability=PUF). When you find variables, you can expand the description by pressing the `+` button and then clicking on the "Survey Year: 2021 National" option. Here is an example describing the variable that serves as the primary key for each table (each table has its own control number, one per row).

![Looking up CONTROL variable](proj2_control.png)


## Loading data

Load each of the files listed above into a table (I suggest using `household`, `project`, etc., and further tasks will mention these tables by name). While loading the data, pay particular attention to the following:

* Write a function that helps avoid duplication when importing these files. This will be important for the next points. You may want to write several functions and then combine them with an overal `import(path_to_table)` function.
* We do not need to import all of the columns.
  * There are several columns of the form `JCOLUMN_NAME` where `COLUMN_NAME` is another column in the same table. These variables indicate if there was any imputation or editing of values. For our purposes we can ignore these columns. But there are also a few columns that start with "JOB" that are valid columns. 
  * There are lots of "weight" related columns that are important to get the sampling procedures correct, but we ill ignore. These have the string "REPW" in them.
  * **Write a regular expression to exclude columns that start with "J" but not "JOB"  which can be passed to the `col_select` argument to avoid importing these columns.**
  * Since writing regular expression to *exclude* patterns is more difficult, **use `select` with `-matches(...)` to exclude the `REPW` columns after importing them.**
  * The files as written have patterns like "'2'" to indicate a category rather than the number two. Write a function that strips the leading and ending quote characters and converts the result to a numeric value (`as.numeric`).
  * Write a regular expression that will match a single `'` followed by an optional "-" character, followed by 1 or more digits, followed by a final "'" character. For example, it should match `'5'` and `'-6'`. Use this pattern with `mutate_if` (see also `str_detect` and `all`) and your function from the previous point to change all of these character columns into numeric values.
  * Several of the numeric variables use either -9 or -6 to indicate missing values. Write a function that will replace all values that are equal to either -9 or -6 with `NA`. Apply this function to any numeric columns in each table (again the `mutate_if` function can be helpful here).
* Factor recode the following variables using the [information in the code book](https://www.census.gov/data-tools/demo/codebook/ahs/ahsdict.html?s_year=2021%20National&s_availability=PUF&s_topic=E0AA57E845AE1B91C75756117388E28B,06C81761722C76EAD104E2317FDBE578,51A3CC29CDA4C84CFECDCE480B3A96F4,CF2CB01171BA8F3AEFD71BEBB3E5EBCE,2512DFBC4BA54E4C60D6AEAB81BC32A6). 
  * `household`: `BLD`, `BATHROOMS`, `DIVISION`, `HOA` (true/false)
  * `person`: `RACE`
  * `mortgage`: `LOANTYPE`


```{r import_data, cache = TRUE}
#match a single `'` followed by an optional "-" character, followed by 1 or more digits
is_num<-function(x){
  all(str_detect(x,"(^'\\d)|('-)"))
}
#strips the leading and ending quote characters and converts the result to a numeric value

to_num <- function(x) {
  as.numeric(gsub("(^')|('$)", "", x))
}
#replace all values that are equal to either -9 or -6 with `NA`
is_na <- function(x) {
  ifelse(x%in%c(-9,-6),NA,x)
}

read_data<-function(file){
  path<-paste0("../data/ahs_2021/",file,".csv.gz")
  read_csv(path,col_select =matches("^JOB|^[^J]")) %>%
  select(-matches("REPW")) %>% 
  mutate_if(is_num,to_num) %>% 
  mutate_if(is.numeric,is_na)
}

project <- read_data('project')
mortgage <- read_data("mortgage")
household <- read_data("household")
person <- read_data("person")

```

recode the following variables using the information in the code book

```{r, cache = TRUE}
household<-household %>% mutate(BLD=case_when(
  BLD==0~'Mobile home or trailer',
  BLD==1~'One-family house, detached',
  BLD==2~'One-family house, attached',
  BLD==3~'Mobile home or trailer',
  BLD==4~'2 apartments',
  BLD==5~'3 to 4 apartments',
  BLD==6~'5 to 9 apartments',
  BLD==7~'10 to 19 apartments',
  BLD==8~'20 to 49 apartments',
  BLD==9~'50 or more apartments',
  BLD==10~'Boat, RV, van, etc.'
),
BATHROOMS=case_when(
  BATHROOMS==01~ 'One full bathroom',
  BATHROOMS==02~ '1.5 bathrooms',
  BATHROOMS==03~ '2 bathrooms',
  BATHROOMS==04~ '2.5 bathrooms',
  BATHROOMS==05~ '3 bathrooms',
  BATHROOMS==06~ 'More than 3 bathrooms',
  BATHROOMS==07~ 'No full bath: sink and tub present',
  BATHROOMS==08~ 'No full bath: sink and toilet present',
  BATHROOMS==09~ 'No full bath: tub and toilet present',
  BATHROOMS==10~ 'No full bath: sink only',
  BATHROOMS==11~ 'No full bath: tub only',
  BATHROOMS==12~ 'No full bath: toilet only',
  BATHROOMS==13~ 'No full bath: no sink, tub or toilet'
),
  DIVISION=case_when(
  DIVISION==1~'New England',
  DIVISION==2~ 'Middle Atlantic',
  DIVISION==3~ 'East North Central',
  DIVISION==4~ 'West North Central',
  DIVISION==5~ 'South Atlantic',
  DIVISION==6~ 'East South Central',
  DIVISION==7~ 'West South Central',
  DIVISION==8~ 'Mountain',
  DIVISION==9~ 'Pacific'
),
  HOA=ifelse(HOA==1,'true','false')
)
person<-person %>% mutate(
  RACE=case_when(
  RACE==01~"White only",
  RACE==02~'Black only',
  RACE==03~'American Indian, Alaska Native only',
  RACE==04~'Asian only',
  RACE==05~'Hawaiian, Pacific Islander only',
  RACE==06~'White / Black',
  RACE==07~'White / American Indian, Alaska Native',
  RACE==08~'White / Asian',
  RACE==09~'White / Hawaiian, Pacific Islander',
  RACE==10~'Black / American Indian, Alaska Native',
  RACE==11~'Black / Asian',
  RACE==12~'Black / Hawaiian, Pacific Islander',
  RACE==13~'American Indian, Alaska Native / Asian',
  RACE==14~'Asian / Hawaiian, Pacific Islander',
  RACE==15~'White / Black / American Indian, Alaska Native',
  RACE==16~'White / Black / Asian',
  RACE==17~'White / American Indian, Alaska Native / Asian',
  RACE==18~ 'White / Asian / Hawaiian, Pacific Islander',
  RACE==19~ 'White / Black / American Indian, Alaska Native / Asian',
  RACE==20~ 'Other combinations of 2 or 3 races',
  RACE==21~ 'Other combinations of 4 or more races'
))
mortgage<-mortgage %>% mutate(LOANTYPE=case_when(
  LOANTYPE==1~'Primary loan',
  LOANTYPE==2~'Secondary loan',
  LOANTYPE==3~'Home equity line of credit'
))

```


## Exploring Household Data

### Required

* Provide a plot that shows the number of households in each `DIVISION`
* Provide a plot of the marginal distribution of `YRBUILT` (hint: what kind of variable is this? See the codebook.)
* Is the market value (`MARKETVAL`) typically higher for households that have a homeowner's association (HOA)?
* Create a column that replaces `UNITSIZE` values with the midpoint of the range. How does the number of bedrooms change with larger homes?

1. the number of households in each `DIVISION`.
```{r}
household %>% ggplot(aes(x=DIVISION))+
  geom_bar(fill=2,col=1)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = "number of households in each DIVISION")
```

2. For disclosure reasons YRBUILT is a categorical value,time variable;The year the unit was built may be determined using multiple items.It's not exactly continuous because people can't remember the exact years,The older ones reflect the number of times over a period of time, and the more recent ones are consecutive years.

```{r}
household %>% ggplot(aes(y=factor(YRBUILT)))+geom_histogram(stat="count")+theme_bw()+ylab('YRBUILT')+ggtitle("When the house was builted")
```

3. yes,the market value (`MARKETVAL`) typically is higher for households that have a homeowner's association (HOA).The distribution is more upward, and the median and mean are higher.

```{r}
household %>% 
  filter(!is.na(HOA))%>%
  group_by(HOA) %>% 
  summarise(mean=mean(MARKETVAL,na.rm = T),median=median(MARKETVAL,na.rm = T))
household %>% filter(!is.na(HOA)) %>% ggplot(aes(y=MARKETVAL,x=HOA,fill=HOA))+
  geom_violin(col="white",trim = FALSE)+
  geom_boxplot(width=.3,position=position_dodge(width=0.9))+
  ylim(0,3*10^6)+theme_bw()
```

4. The relationship cannot be seen directly from the scatter plot because the points tend to cluster together and overlap. The main concentration range can be seen by adding the box plot of the groups. The two are positively correlated. The same is true for a further 2d plot,the larger the house, the more bedrooms there are.But a small number of samples don't fit the pattern.

```{r}
household<-household %>% mutate(UNITSIZE_med=case_when(
UNITSIZE==1~250,
UNITSIZE==2~625,
UNITSIZE==3~875,
UNITSIZE==4~1250,
UNITSIZE==5~1750,
UNITSIZE==6~2250,
UNITSIZE==7~2750,
UNITSIZE==8~3500,
UNITSIZE==9~4000
)) 
household%>% ggplot(aes(y=BEDROOMS,x=UNITSIZE_med,group=BEDROOMS)) +geom_boxplot()
household%>% ggplot(aes(y=BEDROOMS,x=UNITSIZE_med)) +geom_bin_2d()+geom_smooth(method = "lm")
```


### Open Ended

* Use `group_by` and `summarize` to investigate a variable not used as a grouping factor in the required sections above. Write up your findings in written form (3 to 5 sentences).
* If you were looking for an affordable house, where would you choose to live? (Which region as coded in the `DIVISION` column?) Define how you will define "affordable" and explain how will you choose to select a region using your measurement of affordability. Implement affordability using `mutate`. Compare the regions and explain your results.
* Select two numeric variables not used above and investigate the relationship between the two. Use both graphical and numeric summaries. Write up your findings in a short paragraph.

1. The problem with the HRATE variable is:Is this housing unit better, worse, or about the same as your last home?
- Higher-value homes are generally rated positively by tenants.
- Homes with lower values are generally rated negatively by tenants.
- People feel that the house value is moderate if the house evaluation has not changed.
- Most people don't judge,means the question was not answered.
```{r}
household<-household %>% mutate(HRATE=factor(HRATE,levels=c(1,2,3),labels=c('Better','Worse','About the same')))
```


```{r}
household %>%  group_by(HRATE) %>% summarise(n=n(),u=mean(MARKETVAL,na.rm=T),median=median(MARKETVAL,na.rm=T),max=max(MARKETVAL,na.rm=T),min=min(MARKETVAL,na.rm=T))
household %>% ggplot(aes(y=MARKETVAL,x=HRATE,fill=HRATE))+
  geom_violin(col="white",trim = FALSE)+
  geom_boxplot(width=.3,position=position_dodge(width=0.9))+
  ylim(0,2.5*10^6)+theme_bw()
```




2. `TOTHCAMT` is the Total monthly housing costs,and `FINCP` is the Total family income.A smaller proportion of a household's total income means that housing is more affordable use `p`.
- The average household income and the average housing expenditure in each region are selected to reflect the regional level
- *West North Central* is an affordable house place. People can spend more money on other things than renting.Average income is 70356.29,Housing expenditure is only 1163.0793. p is 1.65%
```{r}
household %>%group_by(DIVISION) %>%
  summarise(avg_camt=mean(TOTHCAMT,na.rm = T),
            avg_inc=mean(FINCP,na.rm = T)) %>%
  mutate(p=avg_camt/avg_inc) %>% arrange(p)

```
 
- `UTILAMT` is Monthly total utility amount. `HHAGE` is The age of the head of household. There is more of a trend in the use of electricity by householders around the age of 40.The possible problem is that around the age of 40, there may be older people and children, and the family size is larger.
```{r}
household %>% ggplot(aes(y=UTILAMT,x=HHAGE  ))+geom_point(size=0.05)+geom_smooth()
```


## Exploring Person Data

### Required

* Investigate the `PERSONID` variable. How is variable different from `CONTROL`? If you want to find out how many people live in a household, how can you do that? What is the maximum number of people living in a household in this data set?
* For each household, find the minimum age, median age, and maximum age. Summarize the average of these three values. (Save the table of min, median, and max age for later).

1. The former represents the head of the household, and there may be multiple households under the head of the household, possibly a family. Count the number of people under each head of household to get the number of households, the maximum number of residents is 19

```{r}
person %>% select(PERSONID,CONTROL) %>%
  count(CONTROL) %>% 
  arrange(-n)
```

n is Family size.
```{r}
age<-person %>% group_by(CONTROL) %>% summarise(n=n(),min_age=min(AGE),
                                                max_age=max(AGE),
                                                median_age=median(AGE),
                                                mean=1/3*(min_age+median_age+min_age))
age
```


### Open Ended

* The person table contains several categorical variables. Using grouping on more than variable to explore the relationships between these variables. For example, for each level of variable A, what is the most common value of variable B? Write up what you find.

- `PWALK` is Flag indicating this person has difficulty walking or climbing stairs,Women are more likely to have difficulty climbing stairs.NA is more common in men, probably because more men are reluctant to answer.
```{r}
person %>%  
  group_by(PWALK) %>% 
  count(SEX) %>%
  slice_max(n)
```


## Exploring Mortgage Data

### Required

* Can a single property have more than one mortgage?
* Plot the marginal distribution of `PMTAMT` and interpret the results.
* Mortgages (loans using property as collateral) can be broken down into primary
(has first opportunity to recoup costs in case of a default), secondary (only
recoups costs after the primary is paid), and home equity (a type of secondary
where money is loaned based on the difference between the outstanding mortgage
amount and the assessed value of the property, the "equity"). The `AMMORT`
contains information on the amount of the mortgage for primary and secondary
types. With home equity lines of credit (HELOC) loans, home owners have a credit
limit that they could borrow at any time, which is contained in the `HELOCLIM`
column. Create a new column that merges `AMMROT` and `HELOCLIM` to give a
picture how much money has or could be borrowed. Plot the conditional
distribution of this new column for each of the `LOANTYPE` categories. Compare
both typical values and variation. Write up a 2 or 3 sentences explaining your
results.

more than one mortgage,like Primary loan and Secondary loan.There are 1,035 people with multiple mortgages.
```{r}
mortgage %>%count(CONTROL) %>%summarise(sum(n!=1))
```

- 'PMTAMT' is a skewed distribution, mainly concentrated on the left side, some people have high levels of mortgages. Because most people will choose a lower amount when they take out a mortgage to prevent them from being unable to afford it.

```{r}
mortgage %>% ggplot(aes(PMTAMT))+geom_histogram(bins=300)
```


```{r}
mortgage<-mortgage %>% mutate(both_amount=ifelse(LOANTYPE%in%c('Primary loan','Secondary loan'),AMMORT,HELOCLIM))
mortgage %>% group_by(LOANTYPE) %>% summarise(u=mean(both_amount,na.rm = T),med=median(both_amount,na.rm = T),sd=sd(both_amount,na.rm = T))
mortgage %>% ggplot(aes(x=both_amount,y=LOANTYPE))+geom_violin(fill=2,alpha=0.8)
mortgage %>% ggplot(aes(x=both_amount,y=LOANTYPE))+geom_boxplot(fill=2,alpha=0.8)+xlim(0,2*10^6)
```



### Open Ended

* Compare refinanced mortgages to non-refinanced mortgages (`REFI`). Include at least one plot.
* Demonstrate the use of the filter function to limit attention to properties with more than one mortgage. For these properties, compare the different types of mortgages. For which types of loans do people carry the highest debt?

 The distribution of the two is similar, and the restriction y value is compared in detail, and it is found that the loan amount of refinancing is higher. 
 
```{r}
mortgage %>%filter(!is.na(REFI)) %>%  ggplot(aes(y=both_amount,x=factor(REFI,labels = c('yes','no')),fill=factor(REFI)))+geom_violin()+guides(fill="none")+xlab('REFI')
mortgage %>%filter(!is.na(REFI)) %>% 
ggplot(aes(y=both_amount,group=factor(REFI,labels = c('yes','no')),x=factor(REFI,labels = c('yes','no')),fill=factor(REFI)))+geom_boxplot()+guides(fill="none")+xlab('REFI')+ylim(0,10^6)
```


Primary loan types of loans that people carry the highest debt.
```{r}
one_mortgage<- mortgage %>%group_by(CONTROL) %>% mutate(n=n()) %>% ungroup()%>% filter(n==1)
 one_mortgage %>%  group_by(LOANTYPE) %>% summarise(mean(both_amount,na.rm = T))
 one_mortgage %>%  ggplot(aes(both_amount,LOANTYPE))+geom_violin(fill=2,alpha=0.8)
```

## Using EDA Before Merging

We have now investigated the three main tables individually. Use these results to help you formulate three questions that we can ask after merging the data in the next section. For each question, be sure to state why the previous results caused you to ask this question.

*question*:  
1. 'UTILAMT' total utility amount,and 'HHAGE', the relationship between the age of the household head. The data distribution is not very obvious, which may be related to other factors. We consider that it is related to the number of households, the larger the number of households, the greater the consumption.Consider whether the relationship still exists after the number of households is added.


2. We've looked at the value of homes, combined with table mortgages, and the higher the mortgage the higher the value of the house,But the size of the home can also affect the value, with larger homes likely to be more expensive.

3. We have looked at the distribution of PMTAMT, considering whether different races currently have different debts and are more inclined to borrow.

## Merging Data

### Merging Households and Mortgages

Write a paragraph describing the difference between these ways of merging the `household` and `mortgages` table:

- Use a left join on households (left) and mortgages (right) on the `CONTROL` column
- Use an inner join on households (left) and mortgages (right) on the `CONTROL` column
- First aggregate the `mortgages` table to get total mortgage amounts and payments, then just a left join households to the aggregated mortgages table.

If we would want to compare mortgage amounts for primary, second, and HELOC loans for each region (`DIVISON` column)? Implement this solution and use a facet plot to show the distributions of primary, secondary, and HELOC loans by region.

1. leftjion matches one mortgage per line of household, adding one line if there are two mortgages. If mortgages are not matched, the household line will remain.

2. inner join will retain rows that can be matched, and will remove rows that do not match. One to many adds rows.

3. mortgages are first consolidated in the loan column so that the CONTROL becomes a unique row that corresponds to households one by one. Each row of mortgages is matched when merged, and the table returned is the head of household with a mortgage.


```{r}
mortgage %>% group_by(CONTROL) %>%
  left_join(household,mortgage,by='CONTROL')
mortgage %>% group_by(CONTROL) %>%
  inner_join(household,mortgage,by='CONTROL')
table<-mortgage %>% group_by(CONTROL) %>% mutate(total_amount=sum(both_amount))%>% ungroup()%>% left_join(household,by='CONTROL')
mortgage %>% left_join(household,by='CONTROL') %>% ggplot(aes(y=both_amount,x=DIVISION))+geom_violin(fill=2,alpha=0.8)+
  facet_wrap(~LOANTYPE,ncol=1)
```

### Required

* Using the merge in the previous step, plot the household income `FINCP` against the total mortgage amount. Comment on the results.
* For this step, we will use the column we created above that merged `AMMORT` and `HELOCLIM`. Suppose this column is called `both_amount`. Using pivoting, create columns for the `both_amount_primary`, `both_amount_secondary`, and `both_amount_heloc`. For mortgages with both primary and HELOC mortgages, plot the joint distribution of these values. You will probably need to group by `CONTROL` after pivoting to get totals.


Household income "FINCP" is positively correlated with the total mortgage amount, but there are many high-income families with low mortgages who do not need to borrow too much money.


```{r}
table %>% 
  ggplot(aes(FINCP,total_amount))+
  geom_point()+
  geom_smooth()
```


```{r}
table %>% 
  pivot_wider(names_from =LOANTYPE,values_from = both_amount)%>% 
  group_by(CONTROL) %>% 
  summarise(both_amount_primary=sum(`Primary loan`,na.rm = T),
            both_amount_secondary=sum(`Secondary loan`,na.rm = T),
            both_amount_heloc=sum(`Home equity line of credit`,na.rm = T))
```


### Open Ended

* Select another merge to make (household to person or person to mortgage, in any order).
* Address one or more of your EDA questions from the previous sessions. Provide at least one plot and one use of either `group_by`/`summarize` or an iteration technique to address your question. 
* Did you find an answer to your question or did it prompt new questions? Write up a short paragraph of your results.

```{r}
left_join(person,household)
```

The consumption expenditure of water and electricity increases with the increase of age, and it can be seen that there is a relationship with the number of population, and the larger the family population, the greater the consumption.
```{r}
left_join(household,age,by='CONTROL') %>%count(n)
left_join(household,age,by='CONTROL') %>%mutate(n=ifelse(n<4,n,"more than 5")) %>% ggplot(aes(x=HHAGE,y=UTILAMT,col=factor(n)))+geom_jitter(size=0.5,alpha=0.2)+geom_smooth(aes(fill=factor(n)))
```

The smaller the size of the house, the more people prefer to take out a mortgage, and the larger house may be bought directly by the rich
```{r}
dat<-mortgage %>% group_by(CONTROL) %>% summarise(sum=sum(PMTAMT)) %>% left_join(household,by='CONTROL')%>%mutate(size=ifelse(UNITSIZE%in%c(1:4),'small',ifelse(UNITSIZE%in%c(5:6),'med','big'))) 
dat%>% count(size)
dat%>%ggplot(aes(sum,MARKETVAL,col=size))+geom_point(alpha=0.5)+geom_smooth(method = "lm")
```

The PMTAMT of the races with a higher number of categories was compared. The values were higher for White/Asian and lower for some mixed-race people.
```{r}
(race_pmt<-left_join(mortgage,person,by='CONTROL') %>% group_by(RACE) %>% summarise(n=n(),u=mean(PMTAMT,na.rm = T),med=median(PMTAMT,na.rm = T)) %>% filter(n>100) %>% arrange(-u))

left_join(mortgage,person,by='CONTROL') %>% filter(RACE%in%race_pmt$RACE) %>% ggplot(aes(PMTAMT,RACE))+geom_boxplot()+xlim(0,50000)
```

